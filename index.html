<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨ä¸­æ–‡æ–‡æœ¬ç¿»è¯‘å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 20px;
            position: relative;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }
        textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        .btn-encrypt {
            background-color: #4CAF50;
            color: white;
        }
        .btn-decrypt {
            background-color: #2196F3;
            color: white;
        }
        .btn-clear {
            background-color: #f44336;
            color: white;
        }
        .btn-settings {
            background-color: #FF9800;
            color: white;
            margin-bottom: 10px;
        }
        .btn-save {
            background-color: #4CAF50;
            color: white;
        }
        .btn-validate {
            background-color: #9C27B0;
            color: white;
        }
        button:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .info {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }
        .settings-panel {
            display: none;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .char-input {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .char-input input {
            flex: 1;
            padding: 8px;
            font-size: 18px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }
        .char-input input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .current-chars {
            text-align: center;
            font-size: 18px;
            color: #333;
            margin: 10px 0;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-size: 14px;
            margin-top: 5px;
            padding: 5px;
            background-color: #ffebee;
            border-radius: 3px;
        }
        .warning {
            color: #FF9800;
            font-size: 14px;
            margin-top: 5px;
            padding: 5px;
            background-color: #fff3e0;
            border-radius: 3px;
        }
        .success {
            color: #4CAF50;
            font-size: 14px;
            margin-top: 5px;
            padding: 5px;
            background-color: #e8f5e8;
            border-radius: 3px;
        }
        .security-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        .validation-summary {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .char-count {
            position: absolute;
            right: 10px;
            bottom: 10px;
            font-size: 12px;
            color: #666;
            background: rgba(255,255,255,0.8);
            padding: 2px 6px;
            border-radius: 3px;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            margin: 5px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å®‰å…¨ä¸­æ–‡æ–‡æœ¬ç¿»è¯‘å™¨</h1>
        
        <div class="security-info">
            <strong>ğŸ”’ å®‰å…¨åŠŸèƒ½ï¼š</strong>è¾“å…¥éªŒè¯ | å­—ç¬¦è¿‡æ»¤ | é•¿åº¦é™åˆ¶ | é˜²æ³¨å…¥ | å®Œæ•´æ€§æ£€æŸ¥
        </div>

        <button class="btn-settings" onclick="toggleSettings()">âš™ï¸ å®‰å…¨è®¾ç½®</button>
        
        <div id="settingsPanel" class="settings-panel">
            <label>è‡ªå®šä¹‰äº”ä¸ªå›ºå®šå­—ç¬¦ï¼š</label>
            <div class="current-chars" id="currentChars">å½“å‰å­—ç¬¦ï¼šå¤©åœ°ç„é»„å®‡</div>
            <div class="char-input">
                <input type="text" id="char1" maxlength="1" placeholder="å­—ç¬¦1" oninput="validateCharInput(this)">
                <input type="text" id="char2" maxlength="1" placeholder="å­—ç¬¦2" oninput="validateCharInput(this)">
                <input type="text" id="char3" maxlength="1" placeholder="å­—ç¬¦3" oninput="validateCharInput(this)">
                <input type="text" id="char4" maxlength="1" placeholder="å­—ç¬¦4" oninput="validateCharInput(this)">
                <input type="text" id="char5" maxlength="1" placeholder="å­—ç¬¦5" oninput="validateCharInput(this)">
            </div>
            <div id="settingsError" class="error" style="display: none;"></div>
            <div id="settingsWarning" class="warning" style="display: none;"></div>
            <div class="button-group">
                <button class="btn-save" onclick="saveCustomChars()">ä¿å­˜è®¾ç½®</button>
                <button class="btn-clear" onclick="resetToDefault()">æ¢å¤é»˜è®¤</button>
            </div>
        </div>

        <div class="section">
            <label for="plainText">æ˜æ–‡ï¼š</label>
            <textarea id="plainText" placeholder="è¯·è¾“å…¥è¦è½¬æ¢çš„æ˜æ–‡ï¼ˆæœ€å¤š1000å­—ç¬¦ï¼‰..." 
                      maxlength="1000" oninput="validatePlainText(this)"></textarea>
            <div class="char-count">
                <span id="plainCount">0</span>/1000
            </div>
            <div id="plainWarning" class="warning" style="display: none;"></div>
            <div class="button-group">
                <button class="btn-encrypt" onclick="encryptText()" id="encryptBtn">æ˜æ–‡ â†’ æš—æ–‡</button>
                <button class="btn-validate" onclick="validatePlainTextContent()">éªŒè¯å†…å®¹</button>
                <button class="btn-clear" onclick="clearPlain()">æ¸…ç©º</button>
            </div>
        </div>

        <div class="section">
            <label for="cipherText">æš—æ–‡ï¼š</label>
            <textarea id="cipherText" placeholder="æš—æ–‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
            <div class="progress-bar">
                <div class="progress-fill" id="cipherProgress" style="width: 0%"></div>
            </div>
            <div id="cipherStats" class="validation-summary" style="display: none;"></div>
        </div>

        <div class="section">
            <label for="decryptInput">æš—æ–‡è¾“å…¥ï¼š</label>
            <textarea id="decryptInput" placeholder="è¯·è¾“å…¥è¦è§£å¯†çš„æš—æ–‡..." oninput="validateCipherText(this)"></textarea>
            <div id="cipherWarning" class="warning" style="display: none;"></div>
            <div class="button-group">
                <button class="btn-decrypt" onclick="decryptText()" id="decryptBtn">æš—æ–‡ â†’ æ˜æ–‡</button>
                <button class="btn-validate" onclick="validateCipherFormat()">æ ¼å¼æ£€æŸ¥</button>
                <button class="btn-clear" onclick="clearCipher()">æ¸…ç©º</button>
            </div>
        </div>

        <div class="section">
            <label for="decryptedText">è§£å¯†ç»“æœï¼š</label>
            <textarea id="decryptedText" placeholder="åŸå§‹æ˜æ–‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
            <div id="decryptStats" class="validation-summary" style="display: none;"></div>
        </div>

        <div class="info" id="charInfo">
            æç¤ºï¼šæš—æ–‡ç”±"å¤©åœ°ç„é»„å®‡"äº”ä¸ªå›ºå®šæ–‡å­—çš„ä¸åŒæ’åˆ—ç»„åˆè€Œæˆ
        </div>
    </div>

    <script>
        // é»˜è®¤çš„äº”ä¸ªå›ºå®šæ–‡å­—
        const defaultChars = ['å¤©', 'åœ°', 'ç„', 'é»„', 'å®‡'];
        let cipherChars = [...defaultChars];
        
        // å®‰å…¨é™åˆ¶
        const MAX_PLAIN_LENGTH = 1000;
        const MAX_CIPHER_LENGTH = 5000;
        const ALLOWED_CHARS_REGEX = /^[\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af\w\s.,!?;:()"'-]+$/;
        
        // åˆ›å»ºå­—ç¬¦åˆ°æ•°å­—çš„æ˜ å°„
        let charToNum = {};
        let numToChar = {};
        
        // åˆå§‹åŒ–æ˜ å°„è¡¨
        function initMappings() {
            charToNum = {};
            numToChar = {};
            for (let i = 0; i < cipherChars.length; i++) {
                charToNum[cipherChars[i]] = i;
                numToChar[i] = cipherChars[i];
            }
            document.getElementById('currentChars').textContent = 'å½“å‰å­—ç¬¦ï¼š' + cipherChars.join('');
            document.getElementById('charInfo').textContent = 'æç¤ºï¼šæš—æ–‡ç”±"' + cipherChars.join('') + '"äº”ä¸ªå›ºå®šæ–‡å­—çš„ä¸åŒæ’åˆ—ç»„åˆè€Œæˆ';
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        initMappings();
        
        // åˆ‡æ¢è®¾ç½®é¢æ¿
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // éªŒè¯å­—ç¬¦è¾“å…¥
        function validateCharInput(input) {
            const value = input.value;
            if (value && !/^[\u4e00-\u9fa5]$/.test(value)) {
                input.value = value.slice(0, -1);
                showWarning('settingsWarning', 'è¯·ä½¿ç”¨å•ä¸ªä¸­æ–‡å­—ç¬¦');
            } else {
                hideWarning('settingsWarning');
            }
        }
        
        // éªŒè¯æ˜æ–‡è¾“å…¥
        function validatePlainText(textarea) {
            const text = textarea.value;
            const length = text.length;
            document.getElementById('plainCount').textContent = length;
            
            if (length > MAX_PLAIN_LENGTH) {
                textarea.value = text.slice(0, MAX_PLAIN_LENGTH);
                showWarning('plainWarning', `æ–‡æœ¬é•¿åº¦è¶…è¿‡${MAX_PLAIN_LENGTH}å­—ç¬¦é™åˆ¶`);
            } else if (!ALLOWED_CHARS_REGEX.test(text) && text.length > 0) {
                showWarning('plainWarning', 'åŒ…å«éæ³•å­—ç¬¦ï¼Œå·²è‡ªåŠ¨è¿‡æ»¤');
                textarea.value = text.replace(/[^\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af\w\s.,!?;:()"'-]/g, '');
            } else {
                hideWarning('plainWarning');
            }
            
            updateProgress('plainProgress', length, MAX_PLAIN_LENGTH);
        }
        
        // éªŒè¯å¯†æ–‡è¾“å…¥
        function validateCipherText(textarea) {
            const text = textarea.value;
            const words = text.trim().split(/\s+/);
            
            if (text.length > MAX_CIPHER_LENGTH) {
                textarea.value = text.slice(0, MAX_CIPHER_LENGTH);
                showWarning('cipherWarning', `å¯†æ–‡é•¿åº¦è¶…è¿‡${MAX_CIPHER_LENGTH}å­—ç¬¦é™åˆ¶`);
            } else if (text.length > 0) {
                const invalidChars = [...new Set(text.replace(/\s/g, '').split('').filter(c => !cipherChars.includes(c)))];
                if (invalidChars.length > 0) {
                    showWarning('cipherWarning', `æ£€æµ‹åˆ°æ— æ•ˆå­—ç¬¦: ${invalidChars.join(', ')}`);
                } else {
                    hideWarning('cipherWarning');
                }
            }
        }
        
        // æ˜¾ç¤ºè­¦å‘Š
        function showWarning(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 3000);
        }
        
        // éšè—è­¦å‘Š
        function hideWarning(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(elementId, current, max) {
            const percentage = Math.min((current / max) * 100, 100);
            document.getElementById(elementId).style.width = percentage + '%';
        }
        
        // éªŒè¯æ˜æ–‡å†…å®¹å®Œæ•´æ€§
        function validatePlainTextContent() {
            const text = document.getElementById('plainText').value;
            if (!text.trim()) {
                showWarning('plainWarning', 'è¯·è¾“å…¥æ˜æ–‡å†…å®¹');
                return false;
            }
            
            const stats = {
                length: text.length,
                chinese: (text.match(/[\u4e00-\u9fa5]/g) || []).length,
                english: (text.match(/[a-zA-Z]/g) || []).length,
                numbers: (text.match(/\d/g) || []).length,
                special: (text.match(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g) || []).length
            };
            
            document.getElementById('plainWarning').className = 'success';
            showWarning('plainWarning', `å†…å®¹éªŒè¯é€šè¿‡ï¼šå…±${stats.length}å­—ç¬¦ï¼ˆä¸­æ–‡${stats.chinese}ï¼Œè‹±æ–‡${stats.english}ï¼Œæ•°å­—${stats.numbers}ï¼Œç‰¹æ®Š${stats.special}ï¼‰`);
            return true;
        }
        
        // éªŒè¯å¯†æ–‡æ ¼å¼
        function validateCipherFormat() {
            const text = document.getElementById('decryptInput').value;
            if (!text.trim()) {
                showWarning('cipherWarning', 'è¯·è¾“å…¥å¯†æ–‡å†…å®¹');
                return false;
            }
            
            const words = text.trim().split(/\s+/);
            const validWords = words.filter(word => /^[å¤©åœ°ç„é»„å®‡]+$/.test(word));
            const invalidWords = words.filter(word => !/^[å¤©åœ°ç„é»„å®‡]+$/.test(word));
            
            let message = `æ ¼å¼æ£€æŸ¥ï¼šå…±${words.length}ä¸ªå¯†æ–‡å•å…ƒ`;
            if (invalidWords.length > 0) {
                message += `ï¼Œå‘ç°${invalidWords.length}ä¸ªæ— æ•ˆå•å…ƒ`;
                showWarning('cipherWarning', message);
                return false;
            } else {
                document.getElementById('cipherWarning').className = 'success';
                showWarning('cipherWarning', `${message}ï¼Œæ ¼å¼æ­£ç¡®`);
                return true;
            }
        }
        
        // ä¿å­˜è‡ªå®šä¹‰å­—ç¬¦ï¼ˆå¢å¼ºéªŒè¯ï¼‰
        function saveCustomChars() {
            const chars = [];
            const inputs = [
                document.getElementById('char1').value.trim(),
                document.getElementById('char2').value.trim(),
                document.getElementById('char3').value.trim(),
                document.getElementById('char4').value.trim(),
                document.getElementById('char5').value.trim()
            ];
            
            const errorDiv = document.getElementById('settingsError');
            const warningDiv = document.getElementById('settingsWarning');
            
            // é‡ç½®æ ·å¼
            errorDiv.className = 'error';
            warningDiv.className = 'warning';
            
            // éªŒè¯è¾“å…¥
            for (let i = 0; i < inputs.length; i++) {
                if (!inputs[i]) {
                    errorDiv.textContent = `ç¬¬${i+1}ä¸ªå­—ç¬¦ä¸èƒ½ä¸ºç©ºï¼`;
                    errorDiv.style.display = 'block';
                    return;
                }
                if (chars.includes(inputs[i])) {
                    errorDiv.textContent = 'å­—ç¬¦ä¸èƒ½é‡å¤ï¼';
                    errorDiv.style.display = 'block';
                    return;
                }
                if (!/^[\u4e00-\u9fa5]$/.test(inputs[i])) {
                    errorDiv.textContent = 'è¯·ä½¿ç”¨å•ä¸ªä¸­æ–‡å­—ç¬¦';
                    errorDiv.style.display = 'block';
                    return;
                }
                chars.push(inputs[i]);
            }
            
            // å®‰å…¨æ£€æŸ¥ï¼šæ˜¯å¦ä¸å¸¸ç”¨å­—ç¬¦å†²çª
            const commonChars = ['çš„', 'äº†', 'åœ¨', 'æ˜¯', 'æˆ‘', 'ä½ ', 'ä»–', 'è¿™', 'é‚£', 'æœ‰'];
            const conflicts = chars.filter(c => commonChars.includes(c));
            if (conflicts.length > 0) {
                warningDiv.textContent = `è­¦å‘Šï¼šä½¿ç”¨å¸¸ç”¨å­—å¯èƒ½å½±å“å®‰å…¨æ€§ (${conflicts.join(',')})`;
                warningDiv.style.display = 'block';
            }
            
            // ä¿å­˜è®¾ç½®
            cipherChars = chars;
            initMappings();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`char${i}`).value = '';
            }
            
            errorDiv.style.display = 'none';
            warningDiv.className = 'success';
            warningDiv.textContent = 'è‡ªå®šä¹‰å­—ç¬¦è®¾ç½®å·²å®‰å…¨ä¿å­˜ï¼';
            warningDiv.style.display = 'block';
            
            setTimeout(() => {
                warningDiv.style.display = 'none';
            }, 3000);
        }
        
        // æ¢å¤é»˜è®¤è®¾ç½®
        function resetToDefault() {
            cipherChars = [...defaultChars];
            initMappings();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`char${i}`).value = '';
            }
            
            document.getElementById('settingsWarning').className = 'success';
            showWarning('settingsWarning', 'å·²å®‰å…¨æ¢å¤é»˜è®¤å­—ç¬¦');
        }
        
        // å®‰å…¨çš„æ˜æ–‡è½¬æš—æ–‡
        function encryptText() {
            const plainText = document.getElementById('plainText').value;
            
            // å¤šé‡éªŒè¯
            if (!plainText.trim()) {
                showWarning('plainWarning', 'è¯·è¾“å…¥æ˜æ–‡å†…å®¹');
                return;
            }
            
            if (plainText.length > MAX_PLAIN_LENGTH) {
                showWarning('plainWarning', `æ–‡æœ¬è¿‡é•¿ï¼Œé™åˆ¶${MAX_PLAIN_LENGTH}å­—ç¬¦`);
                return;
            }
            
            if (!ALLOWED_CHARS_REGEX.test(plainText)) {
                showWarning('plainWarning', 'åŒ…å«éæ³•å­—ç¬¦ï¼Œå·²è‡ªåŠ¨è¿‡æ»¤');
                document.getElementById('plainText').value = plainText.replace(/[^\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af\w\s.,!?;:()"'-]/g, '');
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            const btn = document.getElementById('encryptBtn');
            btn.disabled = true;
            btn.textContent = 'åŠ å¯†ä¸­...';
            
            let cipherText = '';
            const startTime = Date.now();
            
            try {
                // åŠ å¯†è¿‡ç¨‹
                for (let i = 0; i < plainText.length; i++) {
                    const char = plainText[i];
                    const charCode = char.charCodeAt(0);
                    
                    if (charCode > 0xFFFF) {
                        throw new Error('æ£€æµ‹åˆ°è¶…å‡ºå¤„ç†èŒƒå›´çš„å­—ç¬¦');
                    }
                    
                    const encrypted = encryptChar(charCode);
                    cipherText += encrypted + ' ';
                    
                    // æ›´æ–°è¿›åº¦
                    updateProgress('cipherProgress', i + 1, plainText.length);
                }
                
                const endTime = Date.now();
                const stats = {
                    original: plainText.length,
                    encrypted: cipherText.trim().split(/\s+/).length,
                    ratio: (cipherText.length / plainText.length).toFixed(2),
                    time: endTime - startTime
                };
                
                document.getElementById('cipherText').value = cipherText.trim();
                
                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                const statsDiv = document.getElementById('cipherStats');
                statsDiv.innerHTML = `
                    <strong>åŠ å¯†ç»Ÿè®¡ï¼š</strong><br>
                    åŸæ–‡ï¼š${stats.original}å­—ç¬¦ | 
                    å¯†æ–‡ï¼š${stats.encrypted}å•å…ƒ | 
                    å‹ç¼©æ¯”ï¼š${stats.ratio} | 
                    è€—æ—¶ï¼š${stats.time}ms
                `;
                statsDiv.style.display = 'block';
                
                document.getElementById('plainWarning').className = 'success';
                showWarning('plainWarning', `åŠ å¯†å®Œæˆï¼å¤„ç†äº†${stats.original}ä¸ªå­—ç¬¦`);
                
            } catch (error) {
                showWarning('plainWarning', `åŠ å¯†é”™è¯¯ï¼š${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®
                btn.disabled = false;
                btn.textContent = 'æ˜æ–‡ â†’ æš—æ–‡';
                setTimeout(() => {
                    updateProgress('cipherProgress', 0, 100);
                }, 1000);
            }
        }
        
        // å®‰å…¨çš„æš—æ–‡è½¬æ˜æ–‡
        function decryptText() {
            const cipherText = document.getElementById('decryptInput').value;
            
            // å¤šé‡éªŒè¯
            if (!cipherText.trim()) {
                showWarning('cipherWarning', 'è¯·è¾“å…¥å¯†æ–‡å†…å®¹');
                return;
            }
            
            const words = cipherText.trim().split(/\s+/);
            if (words.length > 1000) {
                showWarning('cipherWarning', 'å¯†æ–‡å•å…ƒè¿‡å¤šï¼Œé™åˆ¶1000ä¸ª');
                return;
            }
            
            // éªŒè¯æ¯ä¸ªå¯†æ–‡å•å…ƒ
            const invalidWords = [];
            for (const word of words) {
                if (!/^[å¤©åœ°ç„é»„å®‡]+$/.test(word)) {
                    invalidWords.push(word);
                }
            }
            
            if (invalidWords.length > 0) {
                showWarning('cipherWarning', `å‘ç°${invalidWords.length}ä¸ªæ— æ•ˆå¯†æ–‡å•å…ƒ`);
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            const btn = document.getElementById('decryptBtn');
            btn.disabled = true;
            btn.textContent = 'è§£å¯†ä¸­...';
            
            let plainText = '';
            const startTime = Date.now();
            
            try {
                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    const decrypted = decryptWord(word);
                    
                    // éªŒè¯è§£å¯†ç»“æœ
                    if (decrypted < 32 || decrypted > 0xFFFF) {
                        throw new Error(`å­—ç¬¦ç¼–ç è¶…å‡ºå®‰å…¨èŒƒå›´ï¼š${decrypted}`);
                    }
                    
                    plainText += String.fromCharCode(decrypted);
                    
                    // æ›´æ–°è¿›åº¦
                    updateProgress('cipherProgress', i + 1, words.length);
                }
                
                const endTime = Date.now();
                const stats = {
                    encrypted: words.length,
                    decrypted: plainText.length,
                    time: endTime - startTime
                };
                
                document.getElementById('decryptedText').value = plainText;
                
                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                const statsDiv = document.getElementById('decryptStats');
                statsDiv.innerHTML = `
                    <strong>è§£å¯†ç»Ÿè®¡ï¼š</strong><br>
                    å¯†æ–‡ï¼š${stats.encrypted}å•å…ƒ | 
                    åŸæ–‡ï¼š${stats.decrypted}å­—ç¬¦ | 
                    è€—æ—¶ï¼š${stats.time}ms
                `;
                statsDiv.style.display = 'block';
                
                document.getElementById('cipherWarning').className = 'success';
                showWarning('cipherWarning', `è§£å¯†å®Œæˆï¼è¿˜åŸäº†${stats.decrypted}ä¸ªå­—ç¬¦`);
                
            } catch (error) {
                showWarning('cipherWarning', `è§£å¯†é”™è¯¯ï¼š${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®
                btn.disabled = false;
                btn.textContent = 'æš—æ–‡ â†’ æ˜æ–‡';
                setTimeout(() => {
                    updateProgress('cipherProgress', 0, 100);
                }, 1000);
            }
        }
        
        // æ¸…ç©ºæ˜æ–‡åŒºåŸŸ
        function clearPlain() {
            document.getElementById('plainText').value = '';
            document.getElementById('cipherText').value = '';
            document.getElementById('plainCount').textContent = '0';
            document.getElementById('cipherStats').style.display = 'none';
            updateProgress('cipherProgress', 0, 100);
        }
        
        // æ¸…ç©ºæš—æ–‡åŒºåŸŸ
        function clearCipher() {
            document.getElementById('decryptInput').value = '';
            document.getElementById('decryptedText').value = '';
            document.getElementById('decryptStats').style.display = 'none';
            updateProgress('cipherProgress', 0, 100);
        }
        
        // é”®ç›˜å¿«æ·é”®
        document.getElementById('plainText').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                encryptText();
            }
        });
        
        document.getElementById('decryptInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                decryptText();
            }
        });
        
        // é˜²æ­¢ç²˜è´´æ¶æ„å†…å®¹
        document.getElementById('plainText').addEventListener('paste', function(e) {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            const filtered = text.replace(/[^\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af\w\s.,!?;:()"'-]/g, '');
            if (filtered.length > MAX_PLAIN_LENGTH) {
                showWarning('plainWarning', 'ç²˜è´´å†…å®¹è¿‡é•¿ï¼Œå·²æˆªå–');
                this.value = filtered.slice(0, MAX_PLAIN_LENGTH);
            } else {
                this.value = filtered;
            }
            validatePlainText(this);
        });
        
        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        window.addEventListener('load', function() {
            console.log('å®‰å…¨ç¿»è¯‘å™¨å·²åŠ è½½å®Œæˆ - åŒ…å«å¤šé‡éªŒè¯æœºåˆ¶');
        });
    </script>
</body>
</html>